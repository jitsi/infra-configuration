---
- name: Main
  hosts: all
  gather_facts: false
  become: true
  become_user: root
  strategy: free
  vars_files:
    - secrets/jigasi.yml
    - config/vars.yml
    - sites/{{ hcv_environment }}/vars.yml

  pre_tasks:
  # enable vault proxy
    - name: Enable and start vault-proxy
      ansible.builtin.service:
        name: vault-proxy
        enabled: true
        state: started
      tags: "vault"
      when: jigasi_vault_enabled
  # fetch secrets from vault
    - name: Fetch jigasi secrets from vault
      ansible.builtin.uri:
        url: "{{ vault_local_proxy_address }}/v1/secret/data/{{ hcv_environment }}/jigasi/xmpp"
      retries: 5
      delay: 10
      no_log: true
      register: jigasi_xmpp_secret
      ignore_errors: true
      when: jigasi_vault_enabled
      tags: "vault"

    - name: Set jigasi variables from vault secrets
      ansible.builtin.set_fact:
        jigasi_auth_user: "{{ jigasi_xmpp_secret.json.data.data.user }}"
        jigasi_auth_password: "{{ jigasi_xmpp_secret.json.data.data.password }}"
      when:
        - jigasi_vault_enabled
        - jigasi_xmpp_secret is defined
      no_log: true
      tags: "vault"
  roles:
    - { role: "jigasi-auth", tags: "jigasi-auth" }
