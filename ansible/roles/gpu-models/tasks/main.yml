---
- name: Install apt pre-requisites
  ansible.builtin.apt:
    name: s3fs
    state: present

- name: Check models bucket mount # no-qa ignore-errors
  ansible.builtin.shell: |
    set -o pipefail
    mount | grep -q {{ gpu_models_mount_point }}
  args:
    executable: /bin/bash
  register: gpu_models_mount_results
  ignore_errors: true

- name: Create models mount point
  ansible.builtin.file:
    path: "{{ gpu_models_mount_point }}"
    state: directory
    mode: 0755
    recurse: true
  when: gpu_models_mount_results.rc == 1

- name: Create models local storage point
  ansible.builtin.file:
    path: "{{ gpu_models_local_dir }}"
    state: directory
    mode: 0755
    recurse: true

- name: Create gpu models s3fs passwd
  ansible.builtin.copy:
    mode: 0600
    owner: root
    content: "{{ gpu_models_s3fs_credentials }}"
    dest: "{{ gpu_models_s3fs_credentials_path }}"
  no_log: true


- name: Mount models bucket
  ansible.posix.mount:
    src: "s3fs#{{ gpu_models_bucket }}"
    path: "{{ gpu_models_mount_point }}"
    opts: "{{ gpu_models_s3fs_options }}"
    fstype: "fuse"
    state: mounted
  when: gpu_models_mount_results.rc == 1

- name: Copy model bucket contents to local storage point # noqa command-instead-of-module
  ansible.builtin.command: rsync --size-only -a {{ gpu_models_mount_point }}/models/ {{ gpu_models_local_dir }}

- name: Unmount models bucket
  ansible.posix.mount:
    path: "{{ gpu_models_mount_point }}"
    state: unmounted

- name: Remove s3fs credentials
  ansible.builtin.file:
    path: "{{ gpu_models_s3fs_credentials_path }}"
    state: absent

- name: Grab current skynet version from nomad job definition
  ansible.builtin.shell: |
    set -o pipefail
    nomad job inspect skynet-{{ gpu_models_region }} | jq -r ".Job.TaskGroups[].Tasks[].Config.image | split(\":\")[1]"
  register: skynet_version_results
  args:
    executable: /bin/bash

- name: Set skynet version variable from stdout of previous task
  ansible.builtin.set_fact:
    gpu_models_skynet_version: "{{ skynet_version_results.stdout }}"

- name: Grab docker auth config from etc to root
  ansible.builtin.copy:
    mode: 0644
    remote_src: true
    src: "/etc/docker-auth.json"
    dest: "/root/.docker/config.json"

- name: Docker pull latest skynet
  ansible.builtin.command: docker pull {{ gpu_models_docker_image }}
