---
- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    install_recommends: true
    state: present
  notify: Restart fail2ban

- name: Set fail2ban mode to aggressive for ssh
  ansible.builtin.lineinfile:
    path: /etc/fail2ban/jail.conf
    regexp: '^mode'
    insertafter: '^\[sshd\]'
    line: 'mode = aggressive'
  notify: Restart fail2ban

- name: fail2ban ignores configured list of IPs
  ansible.builtin.lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^ignoreip'
    insertafter: '^\[sshd\]'
    line: 'ignoreip = {{ fail2ban_sshd_ignoreip }}'
  notify: Restart fail2ban

- name: Start fail2ban at boot
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
