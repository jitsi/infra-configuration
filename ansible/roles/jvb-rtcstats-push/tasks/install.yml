---
- name: Install list of packages
  apt: name=git state=present

- name: User creation
  user: name="{{jvb_rtcstats_user.username}}"
    groups="{{jvb_rtcstats_user.groups | join(',')}}"
    shell=/bin/bash
    comment="{{jvb_rtcstats_user.real_name}}"
    home="{{jvb_rtcstats_user.homedir}}"
    createhome=yes
    state="{{jvb_rtcstats_user.state}}"

- name: Code Directory
  file: path={{ jvb_rtcstats_push_base_path }} state=directory owner={{ jvb_rtcstats_push_username }} group={{jvb_rtcstats_push_groupname}} recurse=yes

- name: Check out codebase
  become: yes
  become_user: "{{jvb_rtcstats_push_username}}"
  git: repo={{jvb_rtcstats_push_git_repo}} dest={{jvb_rtcstats_push_base_path}} update=yes force=yes accept_hostkey=yes

- name: npm Requirements
  shell: npm install
  become: yes
  become_user: "{{jvb_rtcstats_push_username}}"
  args:
    chdir: "{{jvb_rtcstats_push_base_path}}"

- name: application configuration directory
  file: path={{jvb_rtcstats_push_config_dir}} state=directory

- name: application log directory
  file: path={{jvb_rtcstats_push_log_dir}} state=directory

- name: rsyslog configuration
  template: src=rsyslog.config.j2 dest=/etc/rsyslog.d/26-jvb-rtcstats-push.conf
