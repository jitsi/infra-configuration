---
- apt_key: url=https://prosody.im/files/prosody-debian-packages.key state=present

- apt_repository: >
    repo="deb http://packages.prosody.im/debian {{ansible_distribution_release}} main"
    state=present
    update_cache=yes

- apt: update_cache=yes

- name: remove mark hold on prosody package version
  command: apt-mark unhold {{prosody_package_name}}

- name: "Install prosody package from apt"
  apt: name={{ prosody_package_name }}={{ prosody_version }}
  register: prosody_package_result
  notify:
  - reload prosody

- name: mark hold on prosody package version
  command: apt-mark hold {{prosody_package_name}}

- name: remove patches
  shell: find /usr/lib/prosody -name "*.orig" | xargs -r rm && find /usr/lib/prosody -name ".*.lua" | xargs -r rm
  when: prosody_package_result.changed
  ignore_errors: true