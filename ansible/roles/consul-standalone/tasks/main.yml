---
- name: Register installed Jicofo version
  ansible.builtin.shell: |
    set -o pipefail
    dpkg -s jicofo | grep Version | awk '{print $2}' | cut -d'-' -f2
  register: jicofo_version_shell
  args:
    executable: /bin/bash
  changed_when: jicofo_version_shell.rc != 0

- name: Register installed Meet version
  ansible.builtin.shell: |
    set -o pipefail
    dpkg -s jitsi-meet-web | grep Version | awk '{print $2}' | cut -d'.' -f3 | cut -d'-' -f1
  register: jitsi_meet_version_shell
  args:
    executable: /bin/bash
  changed_when: jitsi_meet_version_shell.rc != 0

- name: Register installed Prosody version
  ansible.builtin.shell: |
    set -o pipefail
    dpkg -s prosody | grep Version | awk '{print $2}' | cut -d'-' -f1
  register: prosody_version_shell
  args:
    executable: /bin/bash
  changed_when: prosody_version_shell.rc != 0

- name: Register installed JVB version
  tags: "gather_versions"
  ansible.builtin.shell: |
    set -o pipefail
    dpkg -s jitsi-videobridge2 | grep Version | awk '{print $2}' | sed 's/..$//'
  args:
    executable: /bin/bash
  register: jvb_version_shell
  changed_when: jvb_version_shell.rc != 0

- name: Set version facts
  ansible.builtin.set_fact:
    signal_version: "{{ jicofo_version_shell.stdout }}-{{ jitsi_meet_version_shell.stdout }}-{{ prosody_version_shell.stdout }}"
    jicofo_version: "{{ jicofo_version_shell.stdout }}"
    jitsi_meet_version: "{{ jitsi_meet_version_shell.stdout }}"
    prosody_version: "{{ prosody_version_shell.stdout }}"
    jvb_version: "{{ jvb_version_shell.stdout }}"

- name: Install consul service file
  ansible.builtin.template:
    mode: 0644
    src: "standalone.json.j2"
    dest: "/etc/consul.d/standalone.json"
  notify: Restart consul for consul-standalone

- name: Enable consul service # noqa ignore-errors
  ansible.builtin.systemd:
    name: consul
    state: started
    enabled: true
  ignore_errors: true
