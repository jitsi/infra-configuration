---
# install the dataplaneapi .deb package
- name: Install haproxy-dataplaneapi
  ansible.builtin.apt:
    deb: "{{ haproxy_dataplaneapi_url }}"
    state: present
  when: haproxy_dataplaneapi_install_flag

# change the dataplaneapi port in the dataplaneapi config
- name: Change dataplaneapi port
  ansible.builtin.replace:
    path: /etc/dataplaneapi/dataplaneapi.yml
    regexp: 'port: 5555'
    replace: 'port: 6700'
  when: haproxy_dataplaneapi_configure_flag

# remove all instances of userlist from dataplaneapi config
- name: Replace userlist from dataplaneapi config
  ansible.builtin.replace:
    path: /etc/dataplaneapi/dataplaneapi.yml
    regexp: '(userlist:[\s\S]*)dataplaneapi'
    replace: |-
      username:
      - insecure: true
        password: insecure
        name: dataplane
  when: haproxy_dataplaneapi_configure_flag

# start dataplane API service
- name: Start dataplane API
  ansible.builtin.systemd:
    name: dataplaneapi
    state: started
    enabled: true
  when: haproxy_dataplaneapi_configure_flag
