---
- name: Add Wavefront apt repository key.
  apt_key:
    url: "{{ wavefront_repo_gpgkey }}"
    state: present
    validate_certs: no
  when: 
    - wavefront_install_proxy
    - wavefront_proxy_from_apt
  tags:
    - prereqs
    - install
    - debian
    - proxy

- name: Add Telgraf apt repository key.
  apt_key:
    id: "{{ wavefront_telegraf_repo_gpgkey_id }}"
    url: "{{ wavefront_telegraf_repo_gpgkey }}"
    state: present
    validate_certs: no
  when: 
    - wavefront_install_collector
    - wavefront_telegraf_from_apt
  tags:
    - prereqs
    - install
    - debian
    - collector

- name: Add second Telgraf apt repository key.
  apt_key:
    url: "{{ wavefront_telegraf_repo_gpgkey_2 }}"
    state: present
    validate_certs: no
  when: 
    - wavefront_install_collector
    - wavefront_telegraf_repo_gpgkey_2 != false
    - wavefront_telegraf_from_apt
  tags:
    - prereqs
    - install
    - debian
    - collector

- name: Install Wavefront pre-requisite packages (Ubuntu)
  apt:
    name: ['apt-transport-https' ]
    state: present
    update_cache: yes
  when: wavefront_proxy_from_apt or wavefront_telegraf_from_apt
  tags:
    - prereqs
    - install
    - debian
    - proxy
    - collector

- name: Add Wavefront Proxy apt repository.
  apt_repository:
    repo: "deb {{ wavefront_proxy_pkg_url }}/ubuntu/ {{ ansible_distribution_release }} main"
    state: present
    update_cache: yes
  when:
    - wavefront_install_proxy
    - wavefront_proxy_from_apt
  tags:
    - prereqs
    - install
    - debian
    - proxy

- name: Add Wavefront Telegraf apt repository.
  apt_repository:
    repo: "deb {{ wavefront_telegraf_pkg_url }}/ubuntu/ {{ ansible_distribution_release }} {{wavefront_telegraf_repo_branch}}"
    state: present
    update_cache: yes
  when: 
    - wavefront_install_collector
    - wavefront_telegraf_from_apt
  tags:
    - prereqs
    - install
    - debian
    - collector

- name: Remove Wavefront Telegraf apt repository.
  apt_repository:
    repo: "deb https://repos.influxdata.com/ubuntu {{ ansible_distribution_release }} stable"
    state: absent
  when: wavefront_telegraf_remove_repo

- name: Remove telegraf apt source file
  file: path=/etc/apt/sources.list.d/repos_influxdata_com_ubuntu.list state=absent
  when: wavefront_telegraf_remove_repo
