---
- name: Update jicofo user password
  ansible.builtin.command: prosodyctl --config /etc/prosody-v{{ item }}/prosody.cfg.lua passwd focus@auth.meet.jitsi
  args:
    stdin: "{{ prosody_focus_visitor_secret }}\n{{ prosody_focus_visitor_secret }}"
    creates: "/var/lib/prosody-v{{ item }}/auth%2emeet%2ejitsi/accounts/focus.dat"
  loop: "{{ range(0, prosody_visitors_count | int, 1) | list }}"
  when: prosody_focus_visitor_secret is defined and prosody_focus_visitor_secret and prosody_focus_visitor_secret != "replaceme"

- name: Update focus prosody user password
  ansible.builtin.command: prosodyctl passwd focus@auth.{{ prosody_domain_name }}
  args:
    stdin: "{{ prosody_focus_secret }}\n{{ prosody_focus_secret }}"
    creates: "/var/lib/prosody/auth%2e{{ prosody_domain_name | regex_replace('\\.', '%2e') }}/accounts/focus.dat"
  when: prosody_focus_secret is defined and prosody_focus_secret and prosody_focus_secret != "replaceme"

- name: Update focus prosody-jvb user
  ansible.builtin.command: |
    prosodyctl --config /etc/prosody-jvb/prosody.cfg.lua passwd "focus@{{ prosody_jvb_auth_domain_name }}"
  args:
    stdin: "{{ prosody_focus_jvb_secret }}\n{{ prosody_focus_jvb_secret }}"
    creates: "/var/lib/prosody-jvb/auth%2ejvb%2e{{ prosody_domain_name | regex_replace('\\.', '%2e') }}/accounts/focus.dat"
  when: prosody_jvb_configure_flag and prosody_focus_jvb_secret is defined and prosody_focus_jvb_secret and prosody_focus_jvb_secret != "replaceme"
