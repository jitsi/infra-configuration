map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

map $arg_tenant $ws_path {
    default   xmpp-websocket;
    ~.+       $arg_tenant/xmpp-websocket;
}

server {
    proxy_connect_timeout       90s;
    proxy_send_timeout          90s;
    proxy_read_timeout          90s;
    send_timeout                90s;

    listen {{ shard_ws_proxy_nginx_port }} default_server;

    # use local consul agent for DNS resolution
    resolver 127.0.0.1:8600 valid=10s;
    resolver_timeout 5s;

    # set the root
    root /usr/share/nginx/html;

    location ~ ^/v1/_ws/(?<shard_name>(?<datacenter>.+)-s\d+)/xmpp-websocket$ {
        set $signal_backend shard-$shard_name.signal.service.$datacenter.dc.consul;
        proxy_pass https://$signal_backend:{{ shard_ws_proxy_signal_dest_port }}/$ws_path$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Proxy-Region {{ shard_ws_proxy_region }};
        proxy_set_header X-Proxy-Host {{ shard_ws_proxy_host }};
        tcp_nodelay on;
    }
}
