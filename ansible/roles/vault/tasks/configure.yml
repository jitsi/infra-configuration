- name: Install vault server configuration
  ansible.builtin.template:
    mode: 0644
    src: server.hcl.j2
    dest: /etc/vault.d/vault.hcl
  notify: Restart vault server
  when: vault_role == "server"

- name: Vault audit log directory
  ansible.builtin.file:
    path: /var/log/vault
    state: directory
    mode: 0755
    owner: vault
    group: vault
  when: vault_role == "server"

- name: Vault server startup
  ansible.builtin.service:
    name: vault
    state: started
    enabled: true
  when: vault_role == "server"

- name: Install vault agent configuration
  ansible.builtin.template:
    mode: 0644
    src: agent.hcl.j2
    dest: /etc/vault.d/agent.hcl
  notify: Restart vault agent
  when: vault_role == "agent"

- name: Vault agent startup
  ansible.builtin.service:
    name: vault-agent
    state: started
    enabled: true
  when:
    - vault_role == "agent"
    - vault_agent_startup
